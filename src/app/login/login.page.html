<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>
      <i class="fas fa-car"></i> Car Meet - Iniciar Sesión
    </ion-title>
    <ion-buttons slot="end" *ngIf="showInstallButton">
      <ion-button (click)="installApp()">
        <i class="fas fa-download" style="margin-right: 5px;"></i>
        Instalar
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <div class="login-container">
    <ion-card class="login-card" *ngIf="!showVerification">
      <ion-card-header>
        <ion-card-title class="text-center">
          <i class="fas fa-sign-in-alt"></i>
          Iniciar Sesión
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <form [formGroup]="loginForm" (ngSubmit)="onSubmit()">
          <!-- Email -->
          <ion-item>
            <ion-label position="stacked">Email *</ion-label>
            <ion-input type="email" formControlName="email" placeholder="tu@email.com"
              [class.ion-invalid]="email?.invalid && email?.touched">
            </ion-input>
          </ion-item>
          <ion-text color="danger" *ngIf="email?.invalid && email?.touched">
            <small *ngIf="email?.errors?.['required']">El email es requerido</small>
            <small *ngIf="email?.errors?.['email']">Ingresa un email válido</small>
          </ion-text>

          <!-- Contraseña -->
          <ion-item>
            <ion-label position="stacked">Contraseña *</ion-label>
            <ion-input type="password" formControlName="password" placeholder="Tu contraseña"
              [class.ion-invalid]="password?.invalid && password?.touched">
            </ion-input>
          </ion-item>
          <ion-text color="danger" *ngIf="password?.invalid && password?.touched">
            <small *ngIf="password?.errors?.['required']">La contraseña es requerida</small>
            <small *ngIf="password?.errors?.['passwordStrength']">
              La contraseña debe contener:
              <ul style="margin: 4px 0; padding-left: 20px;">
                <li *ngIf="!password?.errors?.['passwordStrength'].hasMinLength">Al menos 8 caracteres</li>
                <li *ngIf="!password?.errors?.['passwordStrength'].hasUpperCase">Al menos una mayúscula</li>
                <li *ngIf="!password?.errors?.['passwordStrength'].hasLowerCase">Al menos una minúscula</li>
                <li *ngIf="!password?.errors?.['passwordStrength'].hasNumber">Al menos un número</li>
                <li *ngIf="!password?.errors?.['passwordStrength'].hasSpecialChar">Al menos un carácter especial
                  (@$!%*?&.#_-)</li>
              </ul>
            </small>
          </ion-text>

          <!-- Botón de Login -->
          <!-- reCAPTCHA v2 checkbox -->
          <div id="recaptcha-container-login" class="recaptcha-wrapper" style="margin:12px 0"></div>

          <ion-button expand="block" type="submit" [disabled]="loginForm.invalid || isLoading" class="login-button">
            <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
            <span *ngIf="!isLoading">
              <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
            </span>
          </ion-button>
        </form>

        <!-- Enlace a Registro -->
        <div class="text-center register-link">
          <ion-text>
            ¿No tienes una cuenta?
            <a (click)="goToRegister()" class="register-link-text" style="cursor: pointer;">
              Regístrate aquí
            </a>
          </ion-text>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Formulario de Verificación de 2 Pasos -->
    <ion-card class="login-card" *ngIf="showVerification">
      <ion-card-header>
        <ion-card-title class="text-center">
          <i class="fas fa-shield-alt"></i>
          Verificación de 2 Pasos
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <div class="verification-info">
          <ion-text color="medium">
            <p>Hemos enviado un código de verificación de 6 dígitos a:</p>
            <p><strong>{{ userEmail }}</strong></p>
          </ion-text>
        </div>

        <form [formGroup]="verificationForm" (ngSubmit)="onVerifyCode()">
          <!-- Código de Verificación -->
          <ion-item>
            <ion-label position="stacked">Código de Verificación *</ion-label>
            <ion-input type="text" formControlName="code" placeholder="123456" maxlength="6"
              [class.ion-invalid]="code?.invalid && code?.touched">
            </ion-input>
          </ion-item>
          <ion-text color="danger" *ngIf="code?.invalid && code?.touched">
            <small *ngIf="code?.errors?.['required']">El código es requerido</small>
            <small *ngIf="code?.errors?.['pattern']">El código debe ser de 6 dígitos numéricos</small>
          </ion-text>

          <!-- reCAPTCHA para verificación -->
          <div id="recaptcha-container-verification" class="recaptcha-wrapper" style="margin:12px 0"></div>

          <!-- Botón de Verificación -->
          <ion-button expand="block" type="submit" [disabled]="verificationForm.invalid || isLoading"
            class="login-button">
            <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
            <span *ngIf="!isLoading">
              <i class="fas fa-check"></i> Verificar Código
            </span>
          </ion-button>
        </form>

        <!-- Botón de Reenvío -->
        <div class="resend-section">
          <ion-button expand="block" fill="outline" [disabled]="resendTimer > 0 || isLoading" (click)="resendCode()"
            class="resend-button">
            <i class="fas fa-redo"></i>
            <span *ngIf="resendTimer === 0">Reenviar Código</span>
            <span *ngIf="resendTimer > 0">Reenviar en {{ formattedResendTime }}</span>
          </ion-button>
        </div>

        <!-- Botón para volver al login -->
        <div class="text-center back-link">
          <ion-text>
            <a (click)="goBackToLogin()" class="back-link-text" style="cursor: pointer;">
              <i class="fas fa-arrow-left"></i> Volver al Login
            </a>
          </ion-text>
        </div>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>